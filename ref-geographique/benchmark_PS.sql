
/*
****
**** PROCEDURE STOCKEE DE REFERENCE
****                    GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_DENORM
****

CREATE OR REPLACE PROCEDURE "GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_DENORM"("COUNTRY" VARCHAR(2), "INPUT_PLACE" VARCHAR(16777216))
RETURNS TABLE ("ID" NUMBER(38,0), "POSTCODE" VARCHAR(16777216), "PLACES" VARCHAR(16777216))
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE
 
  		res_fr RESULTSET DEFAULT (SELECT PL.PLACES_ID, REPLACE(PL.POSTCODE,'' ''), PL.LOCALITY
						FROM REF_DEV.REF_GEOGRAPHIQUE.PLACES_DENORM PL
						INNER JOIN REF_DEV.REF_GEOGRAPHIQUE.DATA_LANGUAGES DL1 ON (PL.ISO = DL1.ISO)
						INNER JOIN REF_DEV.REF_GEOGRAPHIQUE.DATA_LANGUAGES DL2 ON (DL2.LANG1 = PL.PLACES_LANGUAGE AND DL2.ISO = PL.ISO)
						WHERE UPPER(PL.LOCALITY) LIKE CONCAT(UPPER(:input_place),''%'') 
						AND (UPPER(PL.ISO)=UPPER(:country) OR UPPER(DL1.SOVEREIGN)=UPPER(:country))
						AND IS_POSTAL=1 
						ORDER BY LENGTH(PL.LOCALITY)
						LIMIT 50);
	
		res_autre RESULTSET DEFAULT (SELECT PL.PLACES_ID, REPLACE(PL.POSTCODE,'' '') , PL.LOCALITY 
						FROM REF_DEV.REF_GEOGRAPHIQUE.PLACES_DENORM PL
						INNER JOIN REF_DEV.REF_GEOGRAPHIQUE.DATA_LANGUAGES DL1 ON (PL.ISO = DL1.ISO)
						INNER JOIN REF_DEV.REF_GEOGRAPHIQUE.DATA_LANGUAGES DL2 ON (DL2.LANG1 = PL.PLACES_LANGUAGE AND DL2.ISO = PL.ISO)
						WHERE UPPER(PL.LOCALITY) LIKE CONCAT(UPPER(:input_place),''%'') 
						AND ( UPPER(PL.ISO)=UPPER(:country) OR UPPER(DL1.SOVEREIGN)=UPPER(:country))
						AND IS_POSTAL=1 
						ORDER BY LENGTH(PL.LOCALITY)
						LIMIT 50);

BEGIN
	IF (country=''FR'') THEN  
		RETURN TABLE(res_fr);
	ELSE
		RETURN TABLE(res_autre); 
	END IF; 
END;
';
*/

-- REQUETE de REFERENCE
SELECT PL.PLACES_ID, REPLACE(PL.POSTCODE,'' ''), PL.LOCALITY
FROM REF_DEV.REF_GEOGRAPHIQUE.PLACES_DENORM PL
 		 INNER JOIN REF_DEV.REF_GEOGRAPHIQUE.DATA_LANGUAGES DL1 ON (PL.ISO = DL1.ISO)
		 INNER JOIN REF_DEV.REF_GEOGRAPHIQUE.DATA_LANGUAGES DL2 ON (DL2.LANG1 = PL.PLACES_LANGUAGE AND DL2.ISO = PL.ISO)
WHERE UPPER(PL.LOCALITY) LIKE CONCAT(UPPER('Montau'),'%')
	AND (UPPER(PL.ISO)=UPPER('FR') OR UPPER(DL1.SOVEREIGN)=UPPER('FR'))
	AND IS_POSTAL=1 
ORDER BY LENGTH(PL.LOCALITY)
LIMIT 50;

-- TEST de REFERENCE 
call REF_DEV.PUBLIC.GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_DENORM('US','Chic');
-- entre 500 ms et 1800 ms (première exécution)
-- 1.3s (Chic)


CREATE OR REPLACE TRANSIENT TABLE REF_DEV.PUBLIC.PLACES_SEARCH AS
SELECT   CASE WHEN DL1.SOVEREIGN IS NULL OR TRIM(DL1.SOVEREIGN)='' THEN UPPER(PL.ISO)
              ELSE UPPER(DL1.SOVEREIGN) 
         END COUNTRY_CODE
        ,PL.PLACES_ID
        ,REPLACE(PL.POSTCODE,' ') AS POSTCODE 
        ,LOCALITY
        --,PL.LOCALITY
        ,PL.PLACES_LANGUAGE, DL1.SOVEREIGN 
FROM REF_DEV.REF_GEOGRAPHIQUE.PLACES_DENORM PL
     INNER JOIN REF_DEV.REF_GEOGRAPHIQUE.DATA_LANGUAGES DL1 ON (PL.ISO = DL1.ISO)
WHERE IS_POSTAL=1
ORDER BY COUNTRY_CODE
;

SELECT * FROM REF_DEV.PUBLIC.PLACES_SEARCH
WHERE COUNTRY_CODE = UPPER('FR')
  AND LOCALITY LIKE CONCAT('Mau','%')
;

SELECT * FROM REF_DEV.PUBLIC.PLACES_SEARCH
WHERE COUNTRY_CODE = UPPER('US')
  AND LOCALITY LIKE CONCAT('San F','%')
ORDER BY LENGTH(LOCALITY), POSTCODE
;


CREATE OR REPLACE PROCEDURE REF_DEV.PUBLIC.GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_SEARCH("COUNTRY" VARCHAR(2), "INPUT_PLACE" VARCHAR(16777216))
RETURNS TABLE ("PLACES_ID" NUMBER(38,0), "POSTCODE" VARCHAR(16777216), "LOCALITY" VARCHAR(16777216))
LANGUAGE SQL
EXECUTE AS OWNER
AS 
DECLARE
    query VARCHAR DEFAULT 'SELECT PLACES_ID, POSTCODE, LOCALITY 
                           FROM REF_DEV.PUBLIC.PLACES_SEARCH
                           WHERE COUNTRY_CODE = UPPER('''||:COUNTRY||''') 
                             AND LOCALITY LIKE CONCAT('''||:INPUT_PLACE||''',''%'')
                           ORDER BY LENGTH(LOCALITY), POSTCODE
                           LIMIT 50';
    res RESULTSET;
BEGIN
    res := (EXECUTE IMMEDIATE :query);             
    RETURN TABLE(res);
END;
;


call REF_DEV.PUBLIC.GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_SEARCH('US','Chic');
-- 1.1 s

CREATE OR REPLACE TRANSIENT TABLE REF_DEV.PUBLIC.PLACES_POSTCODES_SEARCH AS
SELECT   CASE WHEN DL1.SOVEREIGN IS NULL OR TRIM(DL1.SOVEREIGN)='' THEN UPPER(PL.ISO)
              ELSE UPPER(DL1.SOVEREIGN) 
         END COUNTRY_CODE
        ,PL.PLACES_ID
        ,REPLACE(PL.POSTCODE,' ') AS POSTCODE 
        ,LOCALITY
        --,PL.LOCALITY
        ,PL.PLACES_LANGUAGE, DL1.SOVEREIGN
        ,COUNTRY_CODE||'_'||UPPER(LOCALITY)||'_'||POSTCODE as SEARCH_KEY 
FROM REF_DEV.REF_GEOGRAPHIQUE.PLACES_DENORM PL
     INNER JOIN REF_DEV.REF_GEOGRAPHIQUE.DATA_LANGUAGES DL1 ON (PL.ISO = DL1.ISO)
WHERE IS_POSTAL=1
ORDER BY SEARCH_KEY
;

SELECT * FROM REF_DEV.PUBLIC.PLACES_POSTCODES_SEARCH
WHERE COUNTRY_CODE = UPPER('FR')
  AND SEARCH_KEY ILIKE CONCAT('%',CONCAT('Montau','%'))
; 
-- 1000 ms

SELECT * FROM REF_DEV.PUBLIC.PLACES_POSTCODES_SEARCH
WHERE SEARCH_KEY LIKE UPPER('FR')||'_'||'Montau'||'%'
--ORDER BY LENGTH(LOCALITY), POSTCODE
; 
-- 1000 ms

CREATE OR REPLACE PROCEDURE REF_DEV.PUBLIC.GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_SEARCH("COUNTRY" VARCHAR(2), "INPUT_PLACE" VARCHAR(16777216))
RETURNS TABLE ("PLACES_ID" NUMBER(38,0), "POSTCODE" VARCHAR(16777216), "LOCALITY" VARCHAR(16777216))
LANGUAGE SQL
EXECUTE AS OWNER
AS 
DECLARE
    query VARCHAR DEFAULT 'WITH SEL as ( SELECT PLACES_ID, POSTCODE, LOCALITY 
                                         FROM REF_DEV.PUBLIC.PLACES_POSTCODES_SEARCH
                                         WHERE SEARCH_KEY LIKE UPPER('''||:COUNTRY||''')||''_''||UPPER('''||:INPUT_PLACE||''')||''%'' )
                           SELECT * FROM SEL
                           ORDER BY LENGTH(LOCALITY), POSTCODE
                           LIMIT 50';
    res RESULTSET;
BEGIN
    res := (EXECUTE IMMEDIATE :query);             
    RETURN TABLE(res);
END;
;

CREATE OR REPLACE PROCEDURE REF_DEV.PUBLIC.GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_SEARCH("COUNTRY" VARCHAR(2), "INPUT_PLACE" VARCHAR(16777216))
RETURNS TABLE ("PLACES_ID" NUMBER(38,0), "POSTCODE" VARCHAR(16777216), "LOCALITY" VARCHAR(16777216))
LANGUAGE SQL
EXECUTE AS OWNER
AS 
DECLARE
    query VARCHAR DEFAULT 'SELECT PLACES_ID, POSTCODE, LOCALITY 
                           FROM REF_DEV.PUBLIC.PLACES_POSTCODES_SEARCH
                           WHERE SEARCH_KEY LIKE UPPER('''||:COUNTRY||''')||''_''||UPPER('''||:INPUT_PLACE||''')||''%'' 
                           LIMIT 50';
    res RESULTSET;
BEGIN
    res := (EXECUTE IMMEDIATE :query);             
    RETURN TABLE(res);
END;
;

call REF_DEV.PUBLIC.GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_SEARCH('US','San F');
-- 1300 ms

call REF_DEV.PUBLIC.GET_ZIP_AND_PLACE_FROM_COUNTRY_AND_PLACE_SEARCH('US','Chic');
-- 856ms

